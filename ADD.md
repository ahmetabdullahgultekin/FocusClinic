# Ä°rade (Willpower) - Architecture Design Document (ADD)

## 1. Project Overview

**Project Name:** Ä°rade (Willpower)
**Description:** A gamified productivity application that strengthens willpower and self-control. It combines Pomodoro-style focus mechanics with RPG progression, custom willpower goals, and a Token Economy system.
**Platform:** iOS & Android (via Kotlin Multiplatform & Compose Multiplatform).
**Core Philosophy:** "Strengthen your willpower, one focus session at a time." The user earns sparks (currency) by focusing and completing goals, then spends them on real-life rewards or in-app power-ups.
**Data Strategy:** Fully offline. All data is stored locally on-device. No cloud sync, no remote backend.
**Language Policy:** All code in English. UI text in Turkish (primary/default) and English (secondary) via string resources.

## 2. Technical Stack & Libraries

| Concern | Choice | Rationale |
|:---|:---|:---|
| Language | Kotlin (100% commonMain) | Single codebase for Android + iOS |
| UI Framework | Compose Multiplatform (Material 3) | Declarative, shared UI layer |
| Architecture Pattern | **MVI (Model-View-Intent)** | Unidirectional data flow; maps cleanly to session state machines (Idle -> Focusing -> Break -> Completed) |
| Dependency Injection | Koin | Native KMP support, lightweight |
| Navigation | **Decompose + Compose integration** | Lifecycle-aware, mature KMP support. Voyager is no longer actively maintained. |
| Local Database | **SQLDelight** | Fully multiplatform and stable. SQL-first approach generates type-safe Kotlin. Room KMP is still experimental. |
| Concurrency | Kotlin Coroutines & Flow | Standard KMP async primitives |
| Serialization | Kotlinx.Serialization | Multiplatform JSON/CBOR support |
| Date/Time | Kotlinx-datetime | Multiplatform date/time handling |
| Settings/KeyValue | Multiplatform Settings | Simple key-value preferences |

## 3. Architecture Layering (Clean Architecture)

The project strictly follows separation of concerns. Each layer is a **separate Gradle module** to enforce dependency rules at compile time.

```
:core:domain    -> Pure Kotlin, ZERO framework dependencies
:core:data      -> SQLDelight, repository implementations, mappers
:composeApp     -> UI, DI wiring, platform-specific adapters (expect/actual)
```

### A. Domain Layer â€” `:core:domain` (Pure Kotlin)

No dependencies on Android, iOS, SQLDelight, or any framework.

* **Entities:** Core business objects (`FocusSession`, `Clinic`, `UserProfile`, `Reward`, `ShopItem`).
* **Value Objects:** `Coin`, `ExperiencePoints`, `FocusDuration`, `Multiplier`.
* **Repository Interfaces (Ports):**
    * `FocusSessionRepository`
    * `UserProfileRepository`
    * `InventoryRepository`
    * `CustomRewardRepository`
    * `TransactionRepository`
* **Use Cases:**
    * `StartFocusSessionUseCase`
    * `CompleteFocusSessionUseCase` â€” calculates rewards using formulas and rules from Section 4.
    * `InterruptFocusSessionUseCase` â€” handles partial reward calculation.
    * `PurchaseShopItemUseCase` â€” deducts coins, adds item to inventory, records transaction. Also serves as the clinic upgrade mechanism (equipment purchases add multipliers, decorations change visuals).
    * `PurchaseCustomRewardUseCase` â€” deducts coins for real-life rewards, records transaction.
    * `SaveCustomRewardUseCase` â€” creates user-generated real-life rewards.
    * `DeactivateCustomRewardUseCase` â€” soft-deletes a custom reward.
    * `GetUserStatsUseCase` â€” aggregates profile, level, multipliers.
* **Domain Rules:** All reward formulas, multiplier caps, and minimum duration rules live here as constants/functions. No business logic in the data or presentation layer.

### B. Data Layer â€” `:core:data` (Implementation)

* **Data Source:** SQLDelight (local database).
* **DTOs:** Database entity classes generated by SQLDelight `.sq` files.
* **Repository Implementations:** Implement domain port interfaces.
* **Mappers:** DTO <-> Domain Entity converters (extension functions).

### C. Presentation Layer â€” `:composeApp` (UI + Platform)

* **Screens:** Composable functions per feature.
* **ViewModels (ScreenModels):** Process `Intent` -> produce `State` via `StateFlow`. Each screen has:
    * `XxxState` â€” immutable data class representing UI state.
    * `XxxIntent` â€” sealed interface of user actions.
    * `XxxViewModel` â€” reduces intents into state.
* **Platform Adapters (`expect/actual`):**
    * `AppLifecycleObserver` â€” detect app backgrounding (session interruption). Android: `LifecycleEventObserver`. iOS: `NSNotificationCenter`.
    * `TimerNotificationManager` â€” keeps timer alive and sends notifications. Android: `ForegroundService` + `WakeLock` + notification channels. iOS: `UNUserNotificationCenter` scheduled/immediate notifications.
* **Navigation:** Decompose component tree with Compose integration.
* **DI:** Koin modules wiring all layers together.

## 4. Feature Specifications & Business Rules

### Feature 1: The Focus Engine

**Session Flow (State Machine):**
```
Idle -> Focusing -> Completed -> Break -> Idle
                 \-> Interrupted (app backgrounded)
                 \-> Cancelled (user manually stops)
```

**Duration Options:** User selects from predefined durations: `5, 10, 15, 25, 45, 60` minutes.

**Minimum Reward Threshold:** 5 minutes. Sessions under 5 minutes of actual focus earn nothing.

**Interruption Detection:** When the app goes to background (`onPause`), a grace period of **10 seconds** is allowed (e.g., accidental home button). Beyond that, the session is marked `INTERRUPTED`.

**Interrupted Session Rewards (Reduced Partial):**
```
earnedReward = (actualFocusedMinutes / plannedMinutes) * baseReward * 0.5
```
The 0.5 penalty multiplier discourages quitting but doesn't completely punish partial effort. If `actualFocusedMinutes < 5`, rewards are zero regardless.

**Visuals:** Fire emoji on idle, lightning on focusing, glowing star on completion, dash on interruption. Confetti celebration overlay with haptic feedback on successful completion.

**Platform Requirements:**
* **Android:** Foreground Service + WakeLock to prevent the OS from killing the timer. Notification channel for timer status.
* **iOS:** Background task registration. Local notification on timer completion.
* These are implemented via `expect/actual` declarations in `:composeApp`.

### Feature 2: RPG & Progression System

**XP Formula:**
```
XP = floor(FocusMinutes * 10 * ClinicMultiplier)
```

**Coin Formula:**
```
Coins = floor(FocusMinutes * 5 * EfficiencyMultiplier)
```

**Multiplier Cap:** All multipliers (ClinicMultiplier, EfficiencyMultiplier) are capped at **3.0x** maximum. This is enforced in the domain layer.

**Base Multiplier:** 1.0x (no items equipped).

**Level Thresholds:**

| Level | Title (EN) | Title (TR) | Required Total XP |
|:---|:---|:---|:---|
| 1 | Beginner | BaÅŸlangÄ±Ã§ | 0 |
| 2 | Apprentice | Ã‡Ä±rak | 1,000 |
| 3 | Determined | KararlÄ± | 3,000 |
| 5 | Strong | GÃ¼Ã§lÃ¼ | 10,000 |
| 7 | Master | Usta | 25,000 |
| 10 | Legend | Efsane | 60,000 |

**Profile State:** The profile has visual attributes stored in a `ProfileAttributes` value object:
* Theme
* Workspace style
* Tools (equipment)
* Decoration items

These attributes are derived from the user's `Inventory` â€” each purchased item maps to a visual change.

### Feature 3: Token Economy (The Shop)

**Virtual Shop (In-Game Items):**
Items that provide stat multipliers or visual upgrades.

| Item | Cost | Effect | Type |
|:---|:---|:---|:---|
| Focus Stone | 500 | +10% XP (multiplier: 1.1) | EQUIPMENT |
| Perseverance Shield | 300 | +5% Sparks (multiplier: 1.05) | EQUIPMENT |
| Willpower Fire | 800 | +15% XP (multiplier: 1.15) | EQUIPMENT |
| Patience Medal | 600 | +10% Sparks (multiplier: 1.1) | EQUIPMENT |
| Peace Garden | 200 | Visual only | DECORATION |
| Motivation Wall | 150 | Visual only | DECORATION |
| Inspiration Plant | 100 | Visual only | DECORATION |
| Victory Aquarium | 350 | Visual only | DECORATION |

* Multiplier effects from multiple items **stack additively** (e.g., 1.1 + 1.05 = 1.15 total bonus), NOT multiplicatively.
* Total multiplier is capped at 3.0x.

**Real-Life Reward Shop (User-Generated):**
* Full CRUD operations.
* User creates custom rewards: "Watch 1 episode" -> Cost: 300 Sparks.
* Purchasing deducts sparks and records a transaction.
* Soft-delete via `is_active` flag.

**Transaction Integrity:**
* Every coin earn/spend is recorded in the `Transactions` table.
* `UserProfile.current_coins` is the **derived balance** (sum of all transactions), NOT a manually incremented counter. This prevents desync.
* All purchase operations are atomic: deduct coins + add inventory/record reward in a single database transaction.

### Feature 4: Willpower Goals

**Goal Lifecycle:**
* User creates a goal with title, optional description, spark reward, and XP reward.
* Goals appear on the Goals screen as actionable cards.
* User completes a goal â†’ earns sparks and XP, completion is recorded.
* Goals can be edited or deactivated (soft delete).

**Calendar Heatmap:**
* Monthly calendar view on Goals screen showing completion activity.
* Days colored by completion count: 1+ light, 3+ medium, 5+ full primary color.
* Month navigation (previous/next) with completion count recalculation.

**Use Cases:**
* `CreateWillpowerGoalUseCase` â€” validates title (not blank), rewards (> 0), saves goal.
* `CompleteWillpowerGoalUseCase` â€” records completion, creates `EarnGoal` transaction, adds XP.
* `UpdateWillpowerGoalUseCase` â€” validates and updates existing goal.
* `DeactivateWillpowerGoalUseCase` â€” soft-deletes goal by setting `isActive = false`.

### Feature 5: Celebrations & Haptic Feedback

* **CelebrationOverlay** â€” Confetti particle animation with 60 particles, 8 colors, 2.5s duration.
* **HapticFeedback** â€” Platform-specific via `expect/actual` with interface extraction for testability.
  * `medium()` on session start, `success()` on completion, `error()` on interruption.

## 5. Data Model (SQLDelight Schema)

**Table: user_profile** (Singleton â€” always id = 1)

| Column | Type | Notes |
|:---|:---|:---|
| id | INTEGER | PK, always 1 |
| current_xp | INTEGER | Total accumulated XP |
| current_level | INTEGER | Derived from XP thresholds |
| title_rank | TEXT | e.g., "Intern" |
| created_at | INTEGER | Epoch millis |

*Note: `current_coins` is NOT stored here. It is computed from the `transactions` table.*

**Table: focus_sessions**

| Column | Type | Notes |
|:---|:---|:---|
| id | TEXT | PK (UUID string) |
| start_time | INTEGER | Epoch millis |
| end_time | INTEGER | Epoch millis, nullable (null if in progress) |
| planned_duration_minutes | INTEGER | Selected duration |
| actual_focus_minutes | INTEGER | Real focused time |
| status | TEXT | `COMPLETED`, `INTERRUPTED`, `CANCELLED` |
| earned_xp | INTEGER | XP awarded (0 if cancelled) |
| earned_coins | INTEGER | Coins awarded (0 if cancelled) |

**Table: inventory**

| Column | Type | Notes |
|:---|:---|:---|
| item_id | TEXT | PK |
| item_name | TEXT | Display name |
| item_type | TEXT | `DECORATION`, `EQUIPMENT` |
| modifier_type | TEXT | `XP_BONUS`, `COIN_BONUS`, `NONE` (nullable) |
| modifier_value | REAL | e.g., 0.1 for +10% bonus. 0.0 for decorations. |
| purchased_at | INTEGER | Epoch millis |

**Table: custom_rewards**

| Column | Type | Notes |
|:---|:---|:---|
| id | TEXT | PK (UUID string) |
| title | TEXT | "Drink Coffee" |
| cost | INTEGER | Coin price |
| is_active | INTEGER | 1 = active, 0 = soft-deleted |
| created_at | INTEGER | Epoch millis |

**Table: transactions** (Audit trail for the Token Economy)

| Column | Type | Notes |
|:---|:---|:---|
| id | TEXT | PK (UUID string) |
| type | TEXT | `EARN_FOCUS`, `EARN_GOAL`, `SPEND_SHOP`, `SPEND_REWARD` |
| amount | INTEGER | Positive for earn, negative for spend |
| reference_id | TEXT | FK to focus_sessions.id or inventory.item_id or custom_rewards.id |
| description | TEXT | Human-readable: "Completed 25min session", "Purchased Ergonomic Chair" |
| created_at | INTEGER | Epoch millis |

**Table: willpower_goals**

| Column | Type | Notes |
|:---|:---|:---|
| id | TEXT | PK (UUID string) |
| title | TEXT | Goal title |
| description | TEXT | Optional description |
| coin_reward | INTEGER | Sparks earned on completion |
| xp_reward | INTEGER | XP earned on completion |
| is_active | INTEGER | 1 = active, 0 = deactivated |
| created_at | INTEGER | Epoch millis |
| updated_at | INTEGER | Epoch millis |

**Table: goal_completions**

| Column | Type | Notes |
|:---|:---|:---|
| id | TEXT | PK (UUID string) |
| goal_id | TEXT | FK to willpower_goals.id |
| completed_at | INTEGER | Epoch millis |
| earned_coins | INTEGER | Sparks awarded |
| earned_xp | INTEGER | XP awarded |
| note | TEXT | Optional completion note |

**Derived Coin Balance Query:**
```sql
SELECT COALESCE(SUM(amount), 0) AS current_coins FROM transactions;
```

## 6. Project Directory Structure

```text
FocusClinic/
â”œâ”€â”€ build.gradle.kts                  # Root build file
â”œâ”€â”€ settings.gradle.kts               # Module declarations
â”‚
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”œâ”€â”€ build.gradle.kts          # Pure Kotlin module, NO framework deps
â”‚   â”‚   â””â”€â”€ src/commonMain/kotlin/
â”‚   â”‚       â””â”€â”€ com/focusclinic/domain/
â”‚   â”‚           â”œâ”€â”€ model/            # Entities: FocusSession, UserProfile, ShopItem, Clinic
â”‚   â”‚           â”œâ”€â”€ valueobject/      # Coin, ExperiencePoints, FocusDuration, Multiplier
â”‚   â”‚           â”œâ”€â”€ repository/       # Port interfaces
â”‚   â”‚           â”œâ”€â”€ usecase/          # Business logic use cases
â”‚   â”‚           â””â”€â”€ rule/             # Domain constants: XP thresholds, multiplier cap, formulas
â”‚   â”‚
â”‚   â””â”€â”€ data/
â”‚       â”œâ”€â”€ build.gradle.kts          # Depends on :core:domain, SQLDelight
â”‚       â””â”€â”€ src/commonMain/
â”‚           â”œâ”€â”€ kotlin/
â”‚           â”‚   â””â”€â”€ com/focusclinic/data/
â”‚           â”‚       â”œâ”€â”€ repository/   # Repository implementations
â”‚           â”‚       â””â”€â”€ mapper/       # DTO <-> Domain mappers
â”‚           â””â”€â”€ sqldelight/
â”‚               â””â”€â”€ com/focusclinic/data/
â”‚                   â””â”€â”€ database/     # .sq files defining tables and queries
â”‚
â”œâ”€â”€ composeApp/
â”‚   â”œâ”€â”€ build.gradle.kts              # Depends on :core:domain, :core:data, Compose, Koin, Decompose
â”‚   â””â”€â”€ src/
â”‚       â”œâ”€â”€ commonMain/kotlin/
â”‚       â”‚   â””â”€â”€ com/focusclinic/app/
â”‚       â”‚       â”œâ”€â”€ presentation/
â”‚       â”‚       â”‚   â”œâ”€â”€ theme/        # AppTheme, Colors, Typography
â”‚       â”‚       â”‚   â”œâ”€â”€ components/   # Reusable Composables (CalendarHeatmap, CelebrationOverlay)
â”‚       â”‚       â”‚   â””â”€â”€ screens/
â”‚       â”‚       â”‚       â”œâ”€â”€ focus/    # FocusScreen, FocusState, FocusIntent, FocusViewModel
â”‚       â”‚       â”‚       â”œâ”€â”€ clinic/   # ProfileScreen â€” player profile based on inventory
â”‚       â”‚       â”‚       â”œâ”€â”€ goals/   # GoalsScreen â€” willpower goals with calendar heatmap
â”‚       â”‚       â”‚       â”œâ”€â”€ shop/     # ShopScreen â€” virtual items + custom rewards
â”‚       â”‚       â”‚       â””â”€â”€ stats/    # StatsScreen â€” session history, XP progress
â”‚       â”‚       â”œâ”€â”€ navigation/       # Decompose component tree, root component
â”‚       â”‚       â””â”€â”€ di/              # Koin module definitions
â”‚       â”‚
â”‚       â”œâ”€â”€ androidMain/kotlin/       # expect/actual: WakeLock, ForegroundService, Notifications
â”‚       â””â”€â”€ iosMain/kotlin/           # expect/actual: Background tasks, Local notifications
â”‚
â”œâ”€â”€ androidApp/                       # Android entry point (MainActivity, AndroidManifest)
â””â”€â”€ iosApp/                           # iOS entry point (Xcode project)
```

## 7. UI/UX Guidelines

* **Theme:** Ä°rade â€” Willpower/self-control. Primary: Deep Indigo (#3F51B5), Secondary: Warm Gold (#FFC107), Tertiary: Soft Purple (#7E57C2).
* **Dark Mode:** Implemented via `isSystemInDarkTheme()` with complementary dark palette (Light Indigo/Amber/Light Purple tones).
* **Emoji Visuals:**
    * âœ¨ (sparkles) â€” Currency/sparks
    * ğŸ”¥ (fire) â€” Focus ready / willpower
    * âš¡ (lightning) â€” Focus in progress
    * ğŸŒŸ (glowing star) â€” Session completed / success
    * ğŸ’¨ (dash) â€” Session interrupted
    * ğŸ”® ğŸ›¡ï¸ ğŸ… ğŸŒ» ğŸ¨ ğŸŒ¿ ğŸ  â€” Shop items
* **Animations:**
    * `CelebrationOverlay` â€” Confetti particle animation on session completion (60 particles, 8 colors, 2.5s).
    * `AnimatedContent` with fade transitions between screens and phases.
    * `animateItem()` on LazyColumn items for smooth list animations.
    * Animated XP progress bar in profile.
* **Haptic Feedback:** Medium tap on session start, success feedback on completion, error feedback on interruption.
* **Typography:** Material 3 defaults. No custom fonts in V1.
* **Localization:** Turkish (default locale) + English via `composeResources/values/strings.xml`.

## 8. Testing Strategy

| Layer | Test Type | Tool | Coverage Target |
|:---|:---|:---|:---|
| `:core:domain` | Unit tests | kotlin.test | All use cases, reward formulas, level thresholds, multiplier cap logic |
| `:core:data` | Integration tests | SQLDelight in-memory driver | Repository implementations, transaction atomicity |
| `:composeApp` | UI tests | Compose UI testing | Critical flows: start session, purchase item, create reward |

**Test naming convention:** `methodName_WhenCondition_ShouldExpectedBehavior`

Example: `completeFocusSession_WhenDurationUnder5Minutes_ShouldReturnZeroRewards`

## 9. Implementation Steps

1. **Project Setup:** Initialize KMP project with Gradle modules (`:core:domain`, `:core:data`, `:composeApp`). Configure Koin, Decompose, SQLDelight.
2. **Domain Layer:** Define all entities, value objects, repository interfaces, and use cases in `:core:domain`. Implement reward formulas and business rules. Write unit tests.
3. **Data Layer:** Define SQLDelight `.sq` schema files. Implement repository adapters in `:core:data`. Write integration tests.
4. **Navigation Shell:** Set up Decompose root component with screen navigation (Focus, Clinic, Shop, Stats).
5. **Focus Feature:** Build the timer MVI loop (FocusState/FocusIntent/FocusViewModel). Implement `expect/actual` for lifecycle detection, WakeLock, and notifications.
6. **Shop Feature:** Build the virtual shop and custom rewards CRUD screens. Implement purchase transaction logic.
7. **Clinic Feature:** Build the clinic visualization screen that renders based on inventory items.
8. **Stats Feature:** Build session history and XP progress dashboard.
9. **Polish:** Animations, placeholder assets, edge case handling.
